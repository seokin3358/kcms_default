<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뉴스룸</title>

    <!-- CSS 파일들 -->
<link rel="stylesheet" href="./style/splide.min.css">
<link rel="stylesheet" href="./style/reset.css">
<link rel="stylesheet" href="./style/common.css">
<link rel="stylesheet" href="./style/sub03.css">
<link rel="stylesheet" href="./style/swiper-bundle.min.css" />
<link rel="stylesheet" href="./style/aos.css">
<link rel="stylesheet" href="./style/mobile.css">
<link rel="icon" href="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" type="image/x-icon">
    
<style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .error-message {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
        }
        
        .error-icon {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }
        
        .retry-button {
            margin-top: 15px;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .retry-button:hover {
            background: #2980b9;
        }
        
        .newsroom-item {
            transition: transform 0.3s ease;
        }
        
        .newsroom-item:hover {
            transform: translateY(-2px);
        }
        
        .newsroom-item img {
            width: 100%;
            height: 378px;
            object-fit: cover;
            border-radius: 30px;
        }
        
        .more {
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            transition: background 0.3s ease;
            display: inline-block;
        }
        
        .more:hover {
            background: #86898b;
            color: white;
        }
        
        .more.disabled {
            background: #6c757d;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .loading-more {
            text-align: center;
            padding: 20px;
        }
        
        /* 메뉴 드롭다운 스타일 - sub0302 방식 적용 */
        .header .header-gnb .gnb-depth-1 .depth-1.current .depth-item {
            visibility: visible;
            opacity: 1;
            transition: all 0.5s;
        }
        
        .header .header-gnb .gnb-depth-1 .depth-1.current .depth-item .gnb-depth-2 {
            visibility: visible;
            opacity: 1;
            transition: all 0.5s;
        }
        
        .header .header-gnb .gnb-depth-1 .depth-1.current > a > span::before {
            content: "";
            display: block;
            width: calc(100% + 4px);
        }
        
        .header .header-gnb .gnb-depth-1 .depth-item {
            position: absolute;
            top: 40px;
            left: 0;
            width: 100%;
            height: 0;
            overflow: hidden;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            margin-left: -20px;
        }
        
        .header .header-gnb .gnb-depth-1 .depth-item .gnb-depth-2 {
            padding: 10px 0;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
            text-align: left;
        }
        
        .header .header-gnb .gnb-depth-1 .depth-item .gnb-depth-2 span {
            color: #fff;
            font-size: 18px;
        }
        
        .header .header-gnb .gnb-depth-1 .depth-item .gnb-depth-2 span:hover {
            padding-bottom: 2px;
            text-shadow: 1px 1px 5px #09A7E2;
        }
        
        .header .header-gnb .gnb-depth-1 .depth-item .gnb-depth-2 .depth-2-link {
            display: block;
            padding: 8px 0;
            font-size: 16px;
            font-weight: 500;
            color: #ddd;
            transition: color 0.1s;
        }
        
        .header .header-gnb .gnb-depth-1 .depth-item .gnb-depth-2 .depth-2-link:hover, 
        .header .header-gnb .gnb-depth-1 .depth-item .gnb-depth-2 .depth-2-link:focus {
            color: #09A7E2;
            font-weight: 500;
        }
</style>
</head>
<body class="colored_logo">
    <!-- 헤더 영역 -->
    <div id="header" class="header transparent"></div>
    
    <!-- 메인 컨텐츠 -->
    <div class="body sub0301">
        <div class="news_list center_frame">
            <h3>뉴스룸</h3>
            
            <!-- 로딩 상태 -->
            <div id="loadingState" class="loading-more">
                <div class="loading-spinner"></div>
                <p>뉴스룸을 불러오는 중...</p>
            </div>
            
            <!-- 에러 상태 -->
            <div id="errorState" class="error-message" style="display: none;">
                <span class="error-icon">⚠️</span>
                <p>뉴스룸을 불러오는 중 오류가 발생했습니다.</p>
                <button class="retry-button" onclick="loadNewsrooms()">다시 시도</button>
            </div>
            
            <!-- 뉴스룸 목록 -->
            <ul id="newsroomList" style="display: none;">
                <!-- 동적으로 생성될 뉴스룸 아이템들 -->
            </ul>
            
            <!-- 더보기 버튼 -->
            <div class="moreline" id="moreButtonContainer" style="display: none;">
                <a href="#" id="moreButton" class="more">Read More</a>
            </div>
        </div>
    </div>
    
    <!-- 푸터 영역 -->
    <div th:replace="fragments/footer :: footer"></div>
    
    <!-- JavaScript 파일들 -->
    <script src="./js/swiper-bundle.min.js"></script>
    <script src="./js/splide.min.js"></script>
    <script src="./js/aos.js"></script>
    <script src="./js/gsap.min.js"></script>
    <script src="./js/ScrollTrigger.min.js"></script>
    <script src="./js/common.js"></script>
    
    <!-- TOP 버튼 -->
    <button id="toTopBtn" class="to-top"><span>↑</span> TOP</button>
    
    <script>
        // API 기본 URL 설정
        window.API_BASE_URL = '/api';
        
        // 뉴스룸 관련 변수
        let currentPage = 0;
        const pageSize = 6;
        let isLoading = false;
        let hasMoreData = true;
        
        // 헤더와 푸터 로드 함수
        async function loadHeaderAndFooter() {
            try {
                
                // 헤더 로드
                const headerElement = document.getElementById('header');
                
                if (headerElement) {
                    const headerResponse = await fetch('/api/header-section/html');
                    
                    if (headerResponse.ok) {
                        const headerHtml = await headerResponse.text();
                        headerElement.innerHTML = headerHtml;
                    } else {
                        console.error('헤더 HTML 요청 실패:', headerResponse.status);
                    }
                } else {
                    console.error('헤더 요소를 찾을 수 없습니다');
                }
                
                // 푸터는 Thymeleaf 템플릿으로 처리되므로 JavaScript에서 로드하지 않음
                
                // 헤더 스크립트 로드
                const scriptResponse = await fetch('/api/header-section/script');
                
                if (scriptResponse.ok) {
                    const headerScript = await scriptResponse.text();
                    
                    const script = document.createElement('script');
                    script.textContent = headerScript;
                    document.head.appendChild(script);
                    
                    // 헤더 스크립트 로딩 후 메뉴 로드 및 호버 이벤트 초기화
                    setTimeout(() => {
                        loadMenusAndInitializeHoverForSub0301();
                    }, 100);
                } else {
                    console.error('헤더 스크립트 요청 실패:', scriptResponse.status);
                }
                
                
            } catch (error) {
                console.error('헤더 로드 오류:', error);
            }
        }
        
        // 메뉴 로드 함수 (sub0301 전용)
        async function loadMenusForSub0301() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/kitms-menus/tree`);
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.status === 'OK' && result.data.menuTreeJson) {
                        renderMenusForSub0301(result.data.menuTreeJson);
                    } else {
                        console.error('[sub0301] 메뉴 데이터 형식 오류:', result);
                    }
                } else {
                    console.error('[sub0301] 메뉴 API 응답 오류:', response.status);
                }
            } catch (error) {
                console.error('[sub0301] 메뉴 로드 오류:', error);
            }
        }
        
        // 메뉴 렌더링 함수 (sub0301 전용)
        function renderMenusForSub0301(menuTree) {
            const gnbDepth1 = document.querySelector('.gnb-depth-1');
            
            if (!gnbDepth1) {
                return;
            }
            
            gnbDepth1.innerHTML = '';
            
            menuTree.forEach((menu, index) => {
                
                const li = document.createElement('li');
                li.className = 'depth-1';
                
                const link = document.createElement('a');
                link.href = menu.menuUrl || '#';
                link.className = 'depth-1-link hover-underline';
                link.innerHTML = `<span>${menu.menuName}</span>`;
                
                li.appendChild(link);
                
                if (menu.children && menu.children.length > 0) {
                    
                    const depthItem = document.createElement('div');
                    depthItem.className = 'depth-item';
                    
                    const ul = document.createElement('ul');
                    ul.className = 'gnb-depth-2';
                    
                    menu.children.forEach((child, childIndex) => {
                        
                        const childLi = document.createElement('li');
                        childLi.className = 'depth-2';
                        
                        const childLink = document.createElement('a');
                        childLink.href = child.menuUrl || '#';
                        childLink.className = 'depth-2-link';
                        childLink.innerHTML = `<span>${child.menuName}</span>`;
                        
                        childLi.appendChild(childLink);
                        ul.appendChild(childLi);
                    });
                    
                    depthItem.appendChild(ul);
                    li.appendChild(depthItem);
                }
                
                gnbDepth1.appendChild(li);
            });
            
        }
        
        // 헤더 호버 이벤트 초기화 (sub0301 전용) - sub0302 방식 적용
        function initializeHeaderHoverForSub0301() {
            const header = document.querySelector('.header');
            const depth1Items = document.querySelectorAll('.header .header-gnb .gnb-depth-1 .depth-1');
            
            depth1Items.forEach((item, index) => {
                const depthItem = item.querySelector('.depth-item');
                
                if (depthItem) {
                    item.addEventListener('mouseenter', function() {
                        // 헤더에 open 클래스 추가
                        if (header) {
                            header.classList.add('open');
                        }
                        item.classList.add('current');
                        
                        // 하위메뉴 표시
                        depthItem.style.visibility = 'visible';
                        depthItem.style.opacity = '1';
                        
                        // 높이 설정
                        const targetMenu = item.querySelector('.gnb-depth-2');
                        if (targetMenu) {
                            const targetHeight = targetMenu.getBoundingClientRect().height;
                            depthItem.style.height = `${targetHeight}px`;
                        }
                    });
                    
                    item.addEventListener('mouseleave', function() {
                        // 헤더에서 open 클래스 제거
                        if (header) {
                            header.classList.remove('open');
                        }
                        item.classList.remove('current');
                        
                        // 하위메뉴 숨김
                        depthItem.style.visibility = 'hidden';
                        depthItem.style.opacity = '0';
                        depthItem.style.height = '0px';
                    });
                }
            });
        }
        
        // 메뉴 로드 및 호버 이벤트 초기화 (sub0301 전용)
        async function loadMenusAndInitializeHoverForSub0301() {
            try {
                await loadMenusForSub0301();
                initializeHeaderHoverForSub0301();
            } catch (error) {
                console.error('[sub0301] 메뉴 로드 및 호버 초기화 오류:', error);
                // 오류가 발생해도 호버 이벤트는 초기화
                initializeHeaderHoverForSub0301();
            }
        }
        
        // 뉴스룸 로드 함수
        async function loadNewsrooms() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            hideError();
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/newsroom/list?page=${currentPage}&size=${pageSize}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.statusCode === 200 && data.data && data.data.list) {
                    const newsrooms = data.data.list;
                    
                    if (currentPage === 0) {
                        // 첫 페이지 로드
                        displayNewsrooms(newsrooms);
                        showNewsroomList();
                    } else {
                        // 추가 페이지 로드
                        await appendNewsrooms(newsrooms);
                    }
                    
                    // 더 많은 데이터가 있는지 확인
                    hasMoreData = newsrooms.length === pageSize;
                    updateMoreButton();
                    
                    currentPage++;
                } else {
                    throw new Error('뉴스룸 데이터를 불러올 수 없습니다.');
                }
                
            } catch (error) {
                console.error('뉴스룸 로드 오류:', error);
                showError();
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }
        
        // 뉴스룸 목록 표시
        function displayNewsrooms(newsrooms) {
            const newsroomList = document.getElementById('newsroomList');
            
            if (newsrooms.length === 0) {
                newsroomList.innerHTML = '<li style="text-align: center; padding: 40px; color: #666;">등록된 뉴스가 없습니다.</li>';
                return;
            }
            
            newsroomList.innerHTML = newsrooms.map(newsroom => createNewsroomItem(newsroom)).join('');
        }
        
        // 추가 뉴스룸 목록 추가
        async function appendNewsrooms(newsrooms) {
            const newsroomList = document.getElementById('newsroomList');
            const newItems = newsrooms.map(newsroom => createNewsroomItem(newsroom)).join('');
            newsroomList.insertAdjacentHTML('beforeend', newItems);
            
            
            await updateAllImagePaths();            
        }
        
        // 뉴스룸 아이템 생성
        function createNewsroomItem(newsroom) {
            const imageFileName = newsroom.newsroomImage ? 
                (newsroom.newsroomImage.startsWith('/images/') ? 
                    newsroom.newsroomImage.replace('/images/', '') : 
                    newsroom.newsroomImage) :
                'sub0301_newsli1.png'; // 기본 이미지
            
            const date = newsroom.createdAt ? 
                new Date(newsroom.createdAt).toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\./g, '.').replace(/\s/g, '') :
                '2025.01.01';
            
            return `
                <li class="newsroom-item">
                    <a href="${newsroom.newsroomUrl || '#'}" target="_blank">
                        <span class="img">
                            <img class="newsroom-image" data-image="${imageFileName}" 
                                 alt="${newsroom.newsroomTitle || '뉴스 이미지'}">
                        </span>
                        <span class="tit">${newsroom.newsroomTitle || '제목 없음'}</span>
                        <span class="date">${date}</span>
                    </a>
                </li>
            `;
        }
        
        // 더보기 버튼 업데이트
        function updateMoreButton() {
            const moreButton = document.getElementById('moreButton');
            const moreButtonContainer = document.getElementById('moreButtonContainer');
            
            if (hasMoreData) {
                moreButtonContainer.style.display = 'block';
                moreButton.classList.remove('disabled');
                moreButton.textContent = 'Read More';
            } else {
                moreButtonContainer.style.display = 'none';
            }
        }
        
        // 로딩 상태 표시/숨김
        function showLoading(show) {
            const loadingState = document.getElementById('loadingState');
            loadingState.style.display = show ? 'block' : 'none';
        }
        
        // 에러 상태 표시/숨김
        function showError() {
            const errorState = document.getElementById('errorState');
            const newsroomList = document.getElementById('newsroomList');
            const moreButtonContainer = document.getElementById('moreButtonContainer');
            
            errorState.style.display = 'block';
            newsroomList.style.display = 'none';
            moreButtonContainer.style.display = 'none';
        }
        
        function hideError() {
            const errorState = document.getElementById('errorState');
            errorState.style.display = 'none';
        }
        
        // 뉴스룸 목록 표시
        function showNewsroomList() {
            const newsroomList = document.getElementById('newsroomList');
            newsroomList.style.display = 'flex';
        }
        
        // TOP 버튼 설정
        function setupTopButton() {
            const topBtn = document.getElementById("toTopBtn");

            // 스크롤 감지
            window.addEventListener("scroll", function () {
                const showPoint = window.innerHeight * 1.2;

                if (window.scrollY > showPoint) {
                topBtn.classList.add("show");
                } else {
                topBtn.classList.remove("show");
                }
            });

            // 클릭 시 맨 위로 스크롤
            topBtn.addEventListener("click", function () {
                window.scrollTo({
                top: 0,
                behavior: "smooth"
                });
            });
        }
        
        // DOM 로드 완료 후 초기화
        document.addEventListener("DOMContentLoaded", async function () {
            
            // 헤더와 푸터 로드
            await loadHeaderAndFooter();
            
            // 뉴스룸 로드
            await loadNewsrooms();
            
            // 이미지 보안 URL 처리
            await updateAllImagePaths();
            
            // 더보기 버튼 이벤트
            const moreButton = document.getElementById('moreButton');
            if (moreButton) {
                moreButton.addEventListener('click', async function(e) {
                    e.preventDefault(); // 기본 링크 동작 방지
                    await loadNewsrooms();
                });
            }
            
            // TOP 버튼 설정
            setupTopButton();
        });
        
        // 보안 이미지 URL 처리 함수들
        let secureImageUrls = {};
        
        // 보안 이미지 URL 가져오기
        async function getSecureImageUrl(fileName, isDefaultImage = false) {
            
            if (secureImageUrls[fileName]) {
                return secureImageUrls[fileName];
            }
            
            try {
                const url = `/api/secure-images/generate/${fileName}`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    secureImageUrls[fileName] = data.secureUrl;
                    return data.secureUrl;
                } else if (response.status === 404) {
                    console.warn(`❌ 이미지 파일이 존재하지 않음: ${fileName}`);
                    // 기본 이미지가 아니고 뉴스룸 이미지인 경우에만 기본 이미지로 대체
                    if (!isDefaultImage && fileName.includes('temp_')) {
                        return await getSecureImageUrl('sub0301_newsli1.png', true);
                    }
                    return null; // 기본 이미지도 없으면 null 반환
                } else {
                    console.error(`❌ API 오류 응답: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error(`❌ 이미지 토큰 생성 실패: ${fileName}`, error);
            }
            
            return null;
        }
        
        // 이미지 로딩 에러 처리
        function handleImageLoadError(imgElement, fileName) {
            if (imgElement.dataset.retryCount < 2) {
                imgElement.dataset.retryCount = (parseInt(imgElement.dataset.retryCount) || 0) + 1;
                
                
                getSecureImageUrl(fileName).then(newUrl => {
                    if (newUrl) {
                        imgElement.src = newUrl;
                    }
                });
            } else {
                console.warn(`이미지 로딩 최대 재시도 횟수 초과: ${fileName}`);
            }
        }
        
        // 모든 이미지 경로를 보안 URL로 업데이트
        async function updateAllImagePaths() {
            
            // 뉴스룸 이미지들 처리
            const newsroomImages = document.querySelectorAll('.newsroom-image');
            
            for (const img of newsroomImages) {
                const imageFileName = img.getAttribute('data-image');
                if (imageFileName) {
                    
                    const secureUrl = await getSecureImageUrl(imageFileName);
                    if (secureUrl) {
                        img.src = secureUrl;
                        img.addEventListener('error', function() {
                            handleImageLoadError(this, imageFileName);
                        });
                    } else {
                        console.warn(`❌ 이미지 URL을 가져올 수 없음: ${imageFileName}`);
                        // 기본 이미지로 설정
                        img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    }
                }
            }
            // 로고 이미지 처리
            const logoImage = document.querySelector('.logo-image');
            if (logoImage) {
                const imageFile = 'logos/kone_logo.svg';
                console.log(`로고 이미지 처리: ${imageFile}`);
                
                const secureUrl = await getSecureImageUrl(imageFile);
                logoImage.src = secureUrl;
                
                logoImage.addEventListener('error', function() {
                        handleImageLoadError(this, imageFile);
                    });
                }
            
            // 헤더 로고 이미지들 처리
            const headerLogoWhite = document.querySelector('.header-logo-white');
            if (headerLogoWhite) {
                const imageFile = 'logos/kone_logo.svg';
                const secureUrl = await getSecureImageUrl(imageFile);
                headerLogoWhite.src = secureUrl;
                headerLogoWhite.addEventListener('error', function() {
                    handleImageLoadError(this, imageFile);
                });
            }
            
            const headerLogoColor = document.querySelector('.header-logo-color');
            if (headerLogoColor) {
                const imageFile = 'logos/kone_logo_color.svg';
                const secureUrl = await getSecureImageUrl(imageFile);
                headerLogoColor.src = secureUrl;
                headerLogoColor.addEventListener('error', function() {
                    handleImageLoadError(this, imageFile);
                });
            }
            
            // 푸터 로고 이미지 처리
            const footerLogo = document.querySelector('.footer-logo');
            if (footerLogo) {
                const imageFile = 'logos/kone_logo.svg';
                const secureUrl = await getSecureImageUrl(imageFile);
                footerLogo.src = secureUrl;
                footerLogo.addEventListener('error', function() {
                    handleImageLoadError(this, imageFile);
                });
            }
            
            // 파비콘 처리 (파일이 없으면 더미 이미지 유지)
            const favicon = document.querySelector('link[rel="icon"]');
            
        }
    </script>
</body>
</html>