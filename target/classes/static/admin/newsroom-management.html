<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보도자료 관리 - 케이원 관리자</title>
    <link rel="icon" href="../images/ico.ico" type="image/x-icon">
    <!-- 권한 체크 스크립트 -->
    <script src="../common/admin-permission.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* 메인 콘텐츠 */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 60px;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
            
            .main-content.sidebar-collapsed {
                margin-left: 0;
            }
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-size: 14px;
            color: #666;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* 메시지 컨테이너 */
        .message-container {
            margin-bottom: 20px;
        }

        .message-container .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideDown 0.3s ease-out;
        }

        .message-container .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-container .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-container .alert .close-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
            padding: 0;
            margin-left: 10px;
        }

        .message-container .alert .close-btn:hover {
            opacity: 1;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 콘텐츠 카드 */
        .content-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .content-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* 이미지 업로드 관련 스타일 */
        .image-upload-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #f9f9f9;
        }

        .image-upload-container:hover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }

        .image-preview, .current-image {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }

        .image-preview img, .current-image img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .current-image span {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        /* 테이블 이미지 미리보기 스타일 */
        .table img {
            width: 50px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #555;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .featured-badge {
            background-color: #fff3cd;
            color: #856404;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button:hover {
            background-color: #f8f9fa;
        }
        
        .pagination button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- 공통 사이드바 로드 -->
        <div id="adminSidebarContainer"></div>

        <!-- 메인 콘텐츠 -->
        <main class="main-content">
            <!-- 페이지 헤더 -->
            <div class="header">
                <h1 class="header-title">보도자료 관리</h1>
                <div class="user-info">
                    <span class="user-name">관리자</span>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <!-- 메시지 표시 영역 -->
            <div id="messageContainer" class="message-container"></div>

            <!-- 콘텐츠 카드 -->
            <div class="content-card">
                <div class="content-header">
                    <h2 class="content-title">보도자료 목록</h2>
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        새 보도자료 작성
                    </button>
                </div>

        <!-- 검색 섹션 -->
        <div class="search-section">
            <form class="search-form" onsubmit="searchNewsrooms(event)">
                <div class="form-group">
                    <label for="searchKeyword">검색어</label>
                    <input type="text" id="searchKeyword" class="form-control" placeholder="제목으로 검색하세요">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">검색</button>
                    <button type="button" class="btn btn-secondary" onclick="resetSearch()">초기화</button>
                </div>
            </form>
        </div>

        <!-- 보도자료 목록 -->
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>번호</th>
                        <th>제목</th>
                        <th>링크</th>
                        <th>이미지</th>
                        <th>상태</th>
                        <th>등록일</th>
                        <th>최종수정일</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody id="newsroomList">
                    <tr>
                        <td colspan="8" class="loading">보도자료 목록을 불러오는 중...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination" id="pagination">
            <!-- 페이지네이션 버튼들이 여기에 동적으로 생성됩니다 -->
        </div>
    </div>

    <!-- 보도자료 작성/수정 모달 -->
    <div id="newsroomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">새 보도자료 작성</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <form id="newsroomForm" onsubmit="saveNewsroom(event)">
                <div class="form-group">
                    <label for="newsroomTitle">제목 *</label>
                    <input type="text" id="newsroomTitle" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="newsroomUrl">링크 *</label>
                    <input type="url" id="newsroomUrl" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="newsroomImage">이미지</label>
                    <div class="image-upload-container">
                        <input type="file" id="newsroomImage" class="form-control" accept="image/*" onchange="handleImageUpload(event)">
                        <div class="image-preview" id="imagePreview" style="display: none;">
                            <img id="previewImg" src="" alt="미리보기">
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()">제거</button>
                        </div>
                        <div class="current-image" id="currentImage" style="display: none;">
                            <span>현재 이미지:</span>
                            <img id="currentImg" src="" alt="현재 이미지">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newsroomStatus">상태</label>
                    <select id="newsroomStatus" class="form-control">
                        <option value="ACTIVE">활성</option>
                        <option value="INACTIVE">비활성</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        let currentPage = 0;
        let currentSearchType = '';
        let currentSearchKeyword = '';
        let editingNewsroomId = null;
        let uploadedImageFile = null;
        let currentImagePath = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadNewsrooms();
        });

        // 보도자료 목록 로드
        async function loadNewsrooms(page = 0) {
            try {
                currentPage = page;
                const response = await fetch(`${API_BASE_URL}/newsrooms?page=${page}&size=10&sort=createdAt,desc`);
                const pageData = await response.json();
                
                if (response.ok) {
                    displayNewsrooms(pageData.content);
                    displayPagination(pageData);
                } else {
                    showError('보도자료 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('Error loading newsrooms:', error);
                showError('보도자료 목록을 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 보도자료 목록 표시
        function displayNewsrooms(newsrooms) {
            const tbody = document.getElementById('newsroomList');
            
            if (newsrooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">등록된 보도자료가 없습니다.</td></tr>';
                return;
            }
            
            tbody.innerHTML = newsrooms.map((newsroom, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${newsroom.newsroomTitle}</td>
                    <td><a href="${newsroom.newsroomUrl}" target="_blank" style="color: #007bff;">링크</a></td>
                    <td>
                        ${newsroom.newsroomImage ? 
                            `<img src="${newsroom.newsroomImage.startsWith('/images/') ? newsroom.newsroomImage : '/images/' + newsroom.newsroomImage}" 
                                 alt="이미지" 
                                 onerror="tryAlternativePaths(this, '${newsroom.newsroomImage}')">
                             <span style="display:none; color: #999; font-size: 12px;">이미지 없음</span>` : 
                            '<span style="color: #999; font-size: 12px;">이미지 없음</span>'
                        }
                    </td>
                    <td>
                        <span class="status-badge ${newsroom.newsroomStatus === 'ACTIVE' ? 'status-active' : 'status-inactive'}">
                            ${newsroom.newsroomStatus === 'ACTIVE' ? '활성' : '비활성'}
                        </span>
                    </td>
                    <td>${formatDate(newsroom.createdAt)}</td>
                    <td>${formatDate(newsroom.updatedAt)}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editNewsroom(${newsroom.newsroomNo})">수정</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteNewsroom(${newsroom.newsroomNo})">삭제</button>
                    </td>
                </tr>
            `).join('');
        }

        // 페이지네이션 표시
        function displayPagination(pageData) {
            const pagination = document.getElementById('pagination');
            const totalPages = pageData.totalPages;
            const currentPageNum = pageData.number;
            
            let paginationHTML = '';
            
            // 이전 페이지 버튼
            paginationHTML += `
                <button ${currentPageNum === 0 ? 'disabled' : ''} onclick="loadNewsrooms(${currentPageNum - 1})">
                    이전
                </button>
            `;
            
            // 페이지 번호 버튼들
            for (let i = 0; i < totalPages; i++) {
                paginationHTML += `
                    <button class="${i === currentPageNum ? 'active' : ''}" onclick="loadNewsrooms(${i})">
                        ${i + 1}
                    </button>
                `;
            }
            
            // 다음 페이지 버튼
            paginationHTML += `
                <button ${currentPageNum === totalPages - 1 ? 'disabled' : ''} onclick="loadNewsrooms(${currentPageNum + 1})">
                    다음
                </button>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        // 검색
        async function searchNewsrooms(event) {
            event.preventDefault();
            
            const searchKeyword = document.getElementById('searchKeyword').value.trim();
            
            if (!searchKeyword) {
                loadNewsrooms();
                return;
            }
            
            currentSearchType = 'title';
            currentSearchKeyword = searchKeyword;
            
            try {
                const response = await fetch(`${API_BASE_URL}/newsrooms/search/title?title=${encodeURIComponent(searchKeyword)}&page=0&size=10`);
                const pageData = await response.json();
                
                if (response.ok) {
                    displayNewsrooms(pageData.content);
                    displayPagination(pageData);
                } else {
                    showError('검색에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error searching newsrooms:', error);
                showError('검색 중 오류가 발생했습니다.');
            }
        }

        // 검색 초기화
        function resetSearch() {
            document.getElementById('searchKeyword').value = '';
            currentSearchType = '';
            currentSearchKeyword = '';
            loadNewsrooms();
        }

        // 새 보도자료 작성 모달 열기
        function openCreateModal() {
            editingNewsroomId = null;
            uploadedImageFile = null;
            currentImagePath = null;
            originalNewsroomData = null; // 기존 데이터 초기화
            
            document.getElementById('modalTitle').textContent = '새 보도자료 작성';
            document.getElementById('newsroomForm').reset();
            document.getElementById('currentImage').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('newsroomModal').style.display = 'block';
        }

        // 기존 보도자료 데이터 저장용 변수
        let originalNewsroomData = null;

        // 보도자료 수정 모달 열기
        async function editNewsroom(newsroomId) {
            try {
                const response = await fetch(`${API_BASE_URL}/newsrooms/${newsroomId}`);
                
                if (response.ok) {
                    const newsroom = await response.json();
                    editingNewsroomId = newsroomId;
                    
                    // 기존 데이터 저장 (created_by, created_at 보존용)
                    originalNewsroomData = {
                        createdBy: newsroom.createdBy,
                        createdAt: newsroom.createdAt
                    };
                    
                    document.getElementById('modalTitle').textContent = '보도자료 수정';
                    document.getElementById('newsroomTitle').value = newsroom.newsroomTitle || '';
                    document.getElementById('newsroomUrl').value = newsroom.newsroomUrl || '';
                    document.getElementById('newsroomStatus').value = newsroom.newsroomStatus || 'ACTIVE';
                    
                    // 이미지 처리
                    uploadedImageFile = null;
                    if (newsroom.newsroomImage) {
                        showCurrentImage(newsroom.newsroomImage);
                    } else {
                        document.getElementById('currentImage').style.display = 'none';
                        document.getElementById('imagePreview').style.display = 'none';
                    }
                    
                    document.getElementById('newsroomModal').style.display = 'block';
                } else {
                    showError('보도자료 정보를 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('Error loading newsroom:', error);
                showError('보도자료 정보를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 보도자료 저장
        async function saveNewsroom(event) {
            event.preventDefault();
            
            try {
                let imagePath = currentImagePath; // 기존 이미지 경로 유지
                
                // 새 이미지가 업로드된 경우
                if (uploadedImageFile) {
                    const uploadFormData = new FormData();
                    uploadFormData.append('file', uploadedImageFile);
                    uploadFormData.append('tableName', 'KITMS_NEWSROOM');
                    uploadFormData.append('tablePk', 'temp'); // 항상 temp로 전송
                    
                    const uploadResponse = await fetch(`${API_BASE_URL}/kitms-attaches/upload-file`, {
                        method: 'POST',
                        body: uploadFormData
                    });
                    
                    if (uploadResponse.ok) {
                        const uploadResult = await uploadResponse.json();
                        // 임시 파일의 경우 filePath를 사용 (전체 경로)
                        imagePath = uploadResult.data.filePath;
                    } else {
                        const errorResult = await uploadResponse.json();
                        showError('이미지 업로드에 실패했습니다: ' + (errorResult.message || '알 수 없는 오류'));
                        return;
                    }
                }
                
                const formData = {
                    newsroomTitle: document.getElementById('newsroomTitle').value,
                    newsroomUrl: document.getElementById('newsroomUrl').value,
                    newsroomImage: imagePath,
                    newsroomStatus: document.getElementById('newsroomStatus').value
                };
                
                // 수정 모드인 경우 newsroomNo와 기존 데이터 추가
                if (editingNewsroomId) {
                    formData.newsroomNo = editingNewsroomId;
                    // 기존 데이터 보존
                    if (originalNewsroomData) {
                        formData.createdBy = originalNewsroomData.createdBy;
                        formData.createdAt = originalNewsroomData.createdAt;
                    }
                }
                
                const url = editingNewsroomId ? 
                    `${API_BASE_URL}/newsrooms/${editingNewsroomId}` : 
                    `${API_BASE_URL}/newsrooms`;
                
                const method = editingNewsroomId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess(editingNewsroomId ? '보도자료가 성공적으로 수정되었습니다.' : '보도자료가 성공적으로 생성되었습니다.');
                    closeModal();
                    loadNewsrooms(currentPage);
                } else {
                    const errorResult = await response.json();
                    showError('저장에 실패했습니다: ' + (errorResult.message || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('Error saving newsroom:', error);
                showError('저장 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 보도자료 삭제
        async function deleteNewsroom(newsroomId) {
            if (!confirm('정말로 이 보도자료를 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/newsrooms/${newsroomId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showSuccess('보도자료가 성공적으로 삭제되었습니다.');
                    loadNewsrooms(currentPage);
                } else {
                    showError('삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error deleting newsroom:', error);
                showError('삭제 중 오류가 발생했습니다.');
            }
        }

        // 모달 닫기
        function closeModal() {
            document.getElementById('newsroomModal').style.display = 'none';
            editingNewsroomId = null;
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('newsroomModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
        }

        // 이미지 업로드 처리
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 파일 크기 체크 (5MB 제한)
            if (file.size > 5 * 1024 * 1024) {
                showError('이미지 파일 크기는 5MB를 초과할 수 없습니다.');
                event.target.value = '';
                return;
            }

            // 파일 타입 체크
            if (!file.type.startsWith('image/')) {
                showError('이미지 파일만 업로드할 수 있습니다.');
                event.target.value = '';
                return;
            }

            uploadedImageFile = file;
            currentImagePath = null; // 새 이미지 업로드 시 기존 이미지 경로 초기화

            // 미리보기 표시
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById('previewImg');
                const imagePreview = document.getElementById('imagePreview');
                const currentImage = document.getElementById('currentImage');
                
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                currentImage.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // 이미지 제거
        function removeImage() {
            uploadedImageFile = null;
            currentImagePath = null;
            
            const imagePreview = document.getElementById('imagePreview');
            const currentImage = document.getElementById('currentImage');
            const fileInput = document.getElementById('newsroomImage');
            
            imagePreview.style.display = 'none';
            currentImage.style.display = 'none';
            fileInput.value = '';
        }

        // 이미지 URL 생성 함수
        function getImageUrl(imagePath) {
            if (!imagePath) return '';
            
            // 이미 전체 경로인 경우
            if (imagePath.startsWith('/images/')) {
                return imagePath;
            }
            
            // 파일명만 있는 경우 - 기본 경로 반환 (실제 경로는 onerror에서 처리)
            return `/images/${imagePath}`;
        }

        // 대체 경로들을 시도하는 함수
        function tryAlternativePaths(imgElement, fileName) {
            // 백엔드 API를 통해 실제 파일 경로 찾기
            fetch(`${API_BASE_URL}/kitms-attaches/find-image/${fileName}`)
                .then(response => response.json())
                .then(result => {
                    if (result.statusCode === 200 && result.data.filePath) {
                        imgElement.src = result.data.filePath;
                    } else {
                        // API에서 파일을 찾지 못한 경우 이미지 숨기기
                        imgElement.style.display = 'none';
                        const span = imgElement.nextElementSibling;
                        if (span) {
                            span.style.display = 'inline';
                        }
                    }
                })
                .catch(error => {
                    console.error('이미지 경로 찾기 오류:', error);
                    // 오류 발생 시 이미지 숨기기
                    imgElement.style.display = 'none';
                    const span = imgElement.nextElementSibling;
                    if (span) {
                        span.style.display = 'inline';
                    }
                });
        }

        // 현재 이미지 표시 (수정 모드에서)
        function showCurrentImage(imagePath) {
            if (!imagePath) return;
            
            currentImagePath = imagePath;
            const currentImg = document.getElementById('currentImg');
            const currentImage = document.getElementById('currentImage');
            const imagePreview = document.getElementById('imagePreview');
            
            // 이미지 URL 생성 및 onerror 이벤트 설정
            currentImg.src = getImageUrl(imagePath);
            currentImg.onerror = function() {
                // 이미지 로드 실패 시 백엔드 API로 실제 경로 찾기
                tryAlternativePaths(this, imagePath);
            };
            
            currentImage.style.display = 'block';
            imagePreview.style.display = 'none';
        }

        // 성공 메시지 표시
        function showSuccess(message) {
            const messageContainer = document.getElementById('messageContainer');
            if (!messageContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert success';
            alertDiv.innerHTML = `
                <span>${message}</span>
                <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            messageContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // 오류 메시지 표시
        function showError(message) {
            const messageContainer = document.getElementById('messageContainer');
            if (!messageContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert error';
            alertDiv.innerHTML = `
                <span>${message}</span>
                <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            messageContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 7000);
        }

        function logout() {
            window.location.href = '/admin/logout';
        }

        // 공통 사이드바 로드
        async function loadAdminSidebar() {
            try {
                const response = await fetch('/admin/common/admin-sidebar.html');
                if (response.ok) {
                    const sidebarHTML = await response.text();
                    const container = document.getElementById('adminSidebarContainer');
                    if (container) {
                        container.innerHTML = sidebarHTML;
                        
                        // 사이드바 로드 후 이벤트 리스너 등록
                        setupSidebarEvents();
                        
                        // 메뉴 로드
                        loadAdminMenus();
                    } else {
                        console.error('Admin sidebar container not found');
                    }
                } else {
                    console.error('Failed to load admin sidebar, status:', response.status);
                }
            } catch (error) {
                console.error('Error loading admin sidebar:', error);
            }
        }

        // 어드민 메뉴 로드
        async function loadAdminMenus() {
            try {
                const response = await fetch(`${window.location.origin}/api/admin-menus/active`);
                
                if (response.ok) {
                    const menus = await response.json();
                    renderMenus(menus);
                } else {
                    console.error('Failed to load menus, status:', response.status);
                    showMenuError('메뉴를 불러오는데 실패했습니다. (상태: ' + response.status + ')');
                }
            } catch (error) {
                console.error('Error loading admin menus:', error);
                showMenuError('메뉴를 불러오는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 메뉴 렌더링
        function renderMenus(menus) {
            const menuContainer = document.getElementById('sidebarMenu');
            
            if (!menuContainer) {
                console.error('Menu container not found!');
                return;
            }
            
            if (menus.length === 0) {
                menuContainer.innerHTML = '<li class="loading">등록된 메뉴가 없습니다.</li>';
                return;
            }

            menuContainer.innerHTML = menus.map(menu => `
                <li class="menu-item">
                    <a class="menu-link" 
                       href="${menu.menuUrl || '#'}" 
                       data-menu-id="${menu.menuNo}">
                        <span class="menu-icon">${getMenuIcon(menu.menuIcon)}</span>
                        <span class="menu-text">${menu.menuName}</span>
                    </a>
                </li>
            `).join('');

        }

        // 메뉴 아이콘 매핑
        function getMenuIcon(iconName) {
            const iconMap = {
                'dashboard': '📊',
                'content_copy': '📄',
                'people': '👥',
                'settings': '⚙️',
                'announcement': '📢',
                'newspaper': '📰',
                'menu': '📋',
                'admin_panel_settings': '👤',
                'tune': '🎛️',
                'history': '📜'
            };
            return iconMap[iconName] || '📁';
        }

        // 메뉴 오류 표시
        function showMenuError(message) {
            const menuContainer = document.getElementById('sidebarMenu');
            if (menuContainer) {
                menuContainer.innerHTML = `<li class="loading">${message}</li>`;
            }
        }

        // 사이드바 이벤트 설정
        function setupSidebarEvents() {
            // 사이드바 토글 이벤트
            const toggleBtn = document.querySelector('.sidebar-toggle');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const sidebar = document.getElementById('adminSidebar');
                    const mainContent = document.querySelector('.main-content');
                    
                    if (sidebar && mainContent) {
                        sidebar.classList.toggle('collapsed');
                        mainContent.classList.toggle('sidebar-collapsed');
                    }
                });
            }
        }

        // 페이지 로드 시 사이드바 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminSidebar();
        });
    </script>
            </div>
        </main>
    </div>
</body>
</html>
