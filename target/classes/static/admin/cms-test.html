<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CMS ì»¨í…ì¸  í¸ì§‘ê¸°</title>
<meta name="description" content="CMS ì»¨í…ì¸  í¸ì§‘ê¸°">
<meta name="keywords" content="CMS, í¸ì§‘ê¸°, ì¼€ì´ì›">

<!-- CSS íŒŒì¼ë“¤ -->
<link rel="stylesheet" href="../style/splide.min.css">
<link rel="stylesheet" href="../style/reset.css">
<link rel="stylesheet" href="../style/common.css">
<link rel="stylesheet" href="../style/sub01.css">
<link rel="stylesheet" href="../style/sub02.css">
<link rel="stylesheet" href="../style/sub03.css">
<link rel="stylesheet" href="../style/sub04.css">
<link rel="stylesheet" href="../style/swiper-bundle.min.css" />
<link rel="stylesheet" href="../style/aos.css">
<link rel="stylesheet" href="../style/mobile.css">
<link rel="icon" href="../images/ico.ico" type="image/x-icon">

<!-- CKEditor 5 Superbuild CDN -->
<script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/super-build/ckeditor.js" 
        onerror="console.error('CKEditor 5 Superbuild ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨')"></script>

<style>
/* ê´€ë¦¬ì í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
    background-color: #f8f9fa;
    color: #333;
}

.admin-container {
    display: flex;
    min-height: 100vh;
}

/* ì‚¬ì´ë“œë°”ëŠ” ê³µí†µ ì»´í¬ë„ŒíŠ¸ë¡œ ë¡œë“œ */

/* ë©”ì¸ ì½˜í…ì¸  */
.main-content {
    flex: 1;
    margin-left: 250px;
    padding: 20px;
}

.header {
    background: white;
    padding: 20px 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-title {
    font-size: 24px;
    font-weight: 700;
    color: #333;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-name {
    font-size: 14px;
    color: #666;
}

.logout-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.3s ease;
}

.logout-btn:hover {
    background: #c82333;
}

/* í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
.test-container {
    margin: 0 auto;
}

.test-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 20px;
    text-align: center;
    border-radius: 10px;
    margin-bottom: 30px;
}

.test-header h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
}

.test-header p {
    font-size: 1.2em;
    opacity: 0.9;
}

.test-section {
    background: white;
    border-radius: 10px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.test-section h2 {
    color: #333;
    border-bottom: 2px solid #667eea;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.test-button {
    background: #667eea;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin: 5px;
    transition: background 0.3s;
}

.test-button:hover {
    background: #5a6fd8;
}

.test-button.secondary {
    background: #6c757d;
}

.test-button.secondary:hover {
    background: #5a6268;
}

.test-result {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    margin-top: 15px;
    font-family: monospace;
    white-space: pre-wrap;
}

.test-form {
    display: grid;
    gap: 15px;
    margin-bottom: 20px;
}

.test-form input, .test-form textarea {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.test-form textarea {
    min-height: 100px;
    resize: vertical;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .main-content {
        margin-left: 0;
    }

    .header {
        padding: 15px 20px;
    }

    .test-container {
        padding: 10px;
    }
    
    /* ëª¨ë°”ì¼ì—ì„œ CKEditor ë°˜ì‘í˜• ì²˜ë¦¬ */
    .ck-editor__editable {
        min-height: 200px;
        font-size: 14px;
    }
    
    .ck-editor__editable img {
        max-width: 100% !important;
        height: auto !important;
    }
    
    .ck-editor__editable table {
        font-size: 12px;
        max-width: 100% !important;
    }
    
    .editor-container {
        margin: 10px 0;
    }
}


/* CKEditor ë° ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
.editor-container {
    margin: 20px 0;
    max-width: 100%;
    overflow-x: auto;
}

/* CKEditor ì „ì²´ ì»¨í…Œì´ë„ˆ ë°˜ì‘í˜• ì²˜ë¦¬ */
.ck-editor {
    max-width: 100% !important;
}

.ck-editor__main {
    max-width: 100% !important;
}

.ck-editor__editable_inline {
    max-width: 100% !important;
}

.ck-editor__editable {
    min-height: 300px;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-width: 100%;
    overflow-x: auto;
    word-wrap: break-word;
    word-break: break-word;
}

/* CKEditor ì»¨í…ì¸  ë‚´ë¶€ ìš”ì†Œë“¤ì˜ ë°˜ì‘í˜• ì²˜ë¦¬ */
.ck-editor__editable img {
    max-width: 100% !important;
    height: auto !important;
}

.ck-editor__editable table {
    max-width: 100% !important;
    table-layout: fixed !important;
    word-wrap: break-word !important;
}

.ck-editor__editable iframe {
    max-width: 100% !important;
    height: auto !important;
}

.ck-editor__editable video {
    max-width: 100% !important;
    height: auto !important;
}

.ck-editor__editable pre {
    max-width: 100% !important;
    overflow-x: auto !important;
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
}

.ck-editor__editable div {
    max-width: 100% !important;
    word-wrap: break-word !important;
}

.ck-editor__editable p {
    max-width: 100% !important;
    word-wrap: break-word !important;
}

.preview-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.preview-modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    padding: 0;
    border: none;
    width: 95%;
    height: 90%;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.preview-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.preview-header h3 {
    margin: 0;
    font-size: 1.5em;
}

.preview-close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.preview-close:hover {
    opacity: 0.7;
}

.preview-iframe {
    width: 100%;
    height: calc(100% - 70px);
    border: none;
    background: white;
}

.preview-controls {
    background: #f8f9fa;
    padding: 15px 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    gap: 10px;
    align-items: center;
}

.preview-controls button {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.preview-controls button:hover {
    background: #5a6fd8;
}

.preview-controls button.secondary {
    background: #6c757d;
}

.preview-controls button.secondary:hover {
    background: #5a6268;
}

.content-editor-section {
    background: white;
    border-radius: 10px;
    padding: 20px 30px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

</style>
</head>
<body>
    <div class="admin-container">
        <!-- ê³µí†µ ì‚¬ì´ë“œë°” ë¡œë“œ -->
        <div id="adminSidebarContainer"></div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <header class="header">
                <h1 class="header-title">CMS ì»¨í…ì¸  í¸ì§‘ê¸°</h1>
                <div class="user-info">
                    <span class="user-name" id="headerUserName">ê´€ë¦¬ì</span>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </header>

            <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
            <div class="test-container">
            
            <!-- ì»¨í…ì¸  í¸ì§‘ê¸° -->
            <div class="content-editor-section">
                <h2>âœï¸ CMS ì»¨í…ì¸  í¸ì§‘ê¸°</h2>
                <p>ì—ë””í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…ì¸ ë¥¼ í¸ì§‘í•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                
                <div class="test-form">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <label style="font-weight: bold; color: #667eea; min-width: 100px;">í˜ì´ì§€ ì„ íƒ:</label>
                        <select id="editor-page-select" onchange="onPageSelect()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <option value="">í˜ì´ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
                        </select>
                        <button class="test-button secondary" onclick="loadAllContents()" style="padding: 8px 15px; font-size: 12px;">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <input type="hidden" id="editor-page-code" value="">
                    <input type="hidden" id="editor-page-title" value="">
                    
                    <div class="editor-container">
                        <div style="margin-bottom: 10px;">                            
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button class="test-button" onclick="savePreviewContent()" style="padding: 5px 10px; font-size: 12px; background: #ffc107; color: #000;">ì„ì‹œ ì €ì¥</button>
                                <button class="test-button secondary" onclick="applyPreviewContent()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white;">ìµœì¢… ì €ì¥</button>
                                <button class="test-button secondary" onclick="initializeCKEditor()" style="padding: 5px 10px; font-size: 12px; background: #6c757d; color: white;">ì—ë””í„° ì¬ì´ˆê¸°í™”</button>
                            </div>
                        </div>
                        <div id="ckeditor-container" style="border: 1px solid #ddd; border-radius: 5px; min-height: 500px;"></div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="test-button secondary" onclick="previewContent()">ì‹¤ì œ í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸°</button>
                    <button class="test-button" onclick="previewSavedContent()" style="background: #17a2b8; color: white;">ì„ì‹œ ì €ì¥ëœ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</button>
                    <button class="test-button secondary" onclick="openInNewTab()">ìƒˆ íƒ­ì—ì„œ ì—´ê¸°</button>
                </div>
                
                <div id="editor-result" class="test-result" style="display: none; margin-top: 20px;"></div>
            </div>
            
        </div>
    </div>
    
    <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div id="preview-modal" class="preview-modal">
        <div class="preview-modal-content">
            <div class="preview-header">
                <h3>CMS í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸°</h3>
                <button class="preview-close" onclick="closePreviewModal()">&times;</button>
            </div>
            <iframe id="preview-iframe" class="preview-iframe" src="about:blank"></iframe>
            <div class="preview-controls">
                <button onclick="refreshPreview()">ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="openPreviewInNewTab()">ìƒˆ íƒ­ì—ì„œ ì—´ê¸°</button>
                <button class="secondary" onclick="closePreviewModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript íŒŒì¼ë“¤ -->
    <script src="../js/swiper-bundle.min.js"></script>
    <script src="../js/splide.min.js"></script>
    <script src="../js/aos.js"></script>
    <script src="../js/gsap.min.js"></script>
    <script src="../js/ScrollTrigger.min.js"></script>
    //<script src="../js/common.js"></script>
    
    <!-- ê¶Œí•œ ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="../common/admin-permission.js"></script>
    
    <!-- TOP ë²„íŠ¼ -->
    <button id="toTopBtn" class="to-top"><span>â†‘</span> TOP</button>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        const API_BASE_URL = '/api';
        let ckEditor = null;
        let currentPageCode = '';
        let currentPageTitle = '';
        
        // CKEditor ì´ˆê¸°í™”
        window.initializeCKEditor = async function() {
            try {
                const editorElement = document.querySelector('#ckeditor-container');
                if (!editorElement) {
                    console.error('CKEditor ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    showEditorResult('CKEditor ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                // ì»¨í…Œì´ë„ˆ ìš”ì†Œê°€ ìœ íš¨í•œì§€ ê²€ì¦
                if (!editorElement.nodeType || editorElement.nodeType !== 1) {
                    console.error('ìœ íš¨í•˜ì§€ ì•Šì€ ì»¨í…Œì´ë„ˆ ìš”ì†Œì…ë‹ˆë‹¤.');
                    showEditorResult('ìœ íš¨í•˜ì§€ ì•Šì€ ì»¨í…Œì´ë„ˆ ìš”ì†Œì…ë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // ì´ë¯¸ ì´ˆê¸°í™”ëœ ê²½ìš° ì œê±°
                if (ckEditor) {
                    try {
                        await ckEditor.destroy();
                    } catch (destroyError) {
                        console.warn('ê¸°ì¡´ CKEditor ì œê±° ì¤‘ ì˜¤ë¥˜:', destroyError);
                    }
                    ckEditor = null;
                }
                
                // ì»¨í…Œì´ë„ˆ ë‚´ìš© ì´ˆê¸°í™” (ì•ˆì „í•˜ê²Œ)
                try {
                    editorElement.innerHTML = '';
                } catch (innerHTMLError) {
                    console.error('ì»¨í…Œì´ë„ˆ ë‚´ìš© ì´ˆê¸°í™” ì‹¤íŒ¨:', innerHTMLError);
                    showEditorResult('ì»¨í…Œì´ë„ˆ ë‚´ìš© ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // Superbuild ë°©ì‹ìœ¼ë¡œ ì—ë””í„° ì´ˆê¸°í™”
                await waitForSuperbuildAndInitialize();
            } catch (error) {
                console.error('CKEditor ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showEditorResult('CKEditor ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        function waitForSuperbuildAndInitialize() {
            let attempts = 0;
            const maxAttempts = 100;

            function checkAndInitialize() {
                attempts++;
                let foundEditor = null;

                // âœ… ê°€ì¥ ë¨¼ì € super-build ì „ì—­ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
                if (typeof CKEDITOR !== 'undefined' && CKEDITOR.ClassicEditor) {
                    foundEditor = CKEDITOR.ClassicEditor;
                }
                else if (typeof ClassicEditor !== 'undefined') {
                    foundEditor = ClassicEditor;
                }
                else if (typeof CKEditor5 !== 'undefined' && CKEditor5.ClassicEditor) {
                    foundEditor = CKEditor5.ClassicEditor;
                }
                else if (window.ClassicEditor) {
                    foundEditor = window.ClassicEditor;
                }

                if (foundEditor) {
                    const editorElement = document.querySelector('#ckeditor-container');
                    if (editorElement) {
                        // ì»¨í…Œì´ë„ˆê°€ DOMì— ì¡´ì¬í•˜ê³  ë³´ì´ëŠ”ì§€ í™•ì¸
                        if (editorElement.offsetParent !== null) {
                            initializeEditor(foundEditor, editorElement);
                        } else {
                            console.error('CKEditor ì»¨í…Œì´ë„ˆê°€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                            showEditorResult('CKEditor ì»¨í…Œì´ë„ˆê°€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                        }
                    } else {
                        console.error('CKEditor ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        showEditorResult('CKEditor ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
                    }
                } else if (attempts < maxAttempts) {
                    setTimeout(checkAndInitialize, 100);
                } else {
                    console.error('CKEditor 5 Superbuild ë¡œë“œ ì‹œê°„ ì´ˆê³¼');
                    showEditorResult('ì—ë””í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
                }
            }

            checkAndInitialize();
        }

        function initializeEditor(editorClass = null, editorElement = null) {
            if (!editorClass) {
                if (typeof CKEDITOR !== 'undefined' && CKEDITOR.ClassicEditor) {
                    editorClass = CKEDITOR.ClassicEditor; // âœ… ê¸°ë³¸ê°’
                } else if (typeof ClassicEditor !== 'undefined') {
                    editorClass = ClassicEditor;
                } else if (typeof CKEditor5 !== 'undefined' && CKEditor5.ClassicEditor) {
                    editorClass = CKEditor5.ClassicEditor;
                } else if (window.ClassicEditor) {
                    editorClass = window.ClassicEditor;
                } else {
                    console.error('CKEditor 5 Superbuildë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    showEditorResult('CKEditor 5 Superbuildë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return Promise.reject(new Error('CKEditor not found'));
                }
            }

            if (!editorElement) {
                editorElement = document.querySelector('#ckeditor-container');
                if (!editorElement) {
                    console.error('CKEditor ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    showEditorResult('ì—ë””í„° ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return Promise.reject(new Error('Editor container not found'));
                }
            }
            
            // ì»¨í…Œì´ë„ˆ ìš”ì†Œê°€ ìœ íš¨í•œì§€ ì¶”ê°€ ê²€ì¦
            if (!editorElement || !editorElement.nodeType || editorElement.nodeType !== 1) {
                console.error('ìœ íš¨í•˜ì§€ ì•Šì€ ì»¨í…Œì´ë„ˆ ìš”ì†Œì…ë‹ˆë‹¤.');
                showEditorResult('ìœ íš¨í•˜ì§€ ì•Šì€ ì»¨í…Œì´ë„ˆ ìš”ì†Œì…ë‹ˆë‹¤.', 'error');
                return Promise.reject(new Error('Invalid container element'));
            }

            // âœ… ì—¬ê¸°ì„œ Promiseë¥¼ ë°˜í™˜í•´ì•¼ ì™¸ë¶€ì—ì„œ .then() ì‚¬ìš© ê°€ëŠ¥
            return editorClass.create(editorElement, {
                    // ë°˜ì‘í˜• ì„¤ì •
                    ui: {
                        viewportOffset: {
                            top: 0,
                            right: 0,
                            bottom: 0,
                            left: 0
                        }
                    },
                    removePlugins: [
                            // í˜‘ì—…/ì½”ë©˜íŠ¸/íŠ¸ë™ì²´ì¸ì§€/ë¦¬ë¹„ì „/í´ë¼ìš°ë“œ
                            'Comments',
                            'TrackChanges',
                            'TrackChangesData',
                            'RevisionHistory',
                            'RealTimeCollaborativeComments',
                            'RealTimeCollaborativeTrackChanges',
                            'RealTimeCollaborativeRevisionHistory',
                            'PresenceList',
                            'CloudServices',

                              // âœ… CKBox & EasyImage (CloudServices ì˜ì¡´)
                            'CKBox', 'CKBoxEditing', 'CKBoxUI',
                            'EasyImage',

                            // í”„ë¦¬ë¯¸ì—„/í‰ê°€ìš© ë“±
                            'ExportPdf',
                            'ExportWord',
                            'WProofreader',
                            'MathType',

                              // âœ… í”„ë¦¬ë¯¸ì—„: AI & Pagination
                            'AIAssistant','AIAssistantUI','AIAssistantEditing','AIPrompt',
                            'Pagination','PaginationEditing',

                            // ê¸°íƒ€ super-buildì— ì„ì—¬ìˆëŠ” ê²ƒë“¤
                            'SlashCommand',
                            'Template',
                            'DocumentOutline',
                            'FormatPainter',
                            'TableOfContents',
                            'PasteFromOfficeEnhanced',
                            'CaseChange'

                            
                            ],
                    toolbar: {
                        items: [
                        'heading','|',
                        'bold','italic','underline','strikethrough','|',
                        'fontSize','fontFamily','fontColor','fontBackgroundColor','|',
                        'bulletedList','numberedList','|',
                        'outdent','indent','|',
                        'alignment','|',
                        'link','uploadImage','insertTable','|',   // âœ… insertImage â†’ uploadImage
                        'blockQuote','codeBlock','|',
                        'sourceEditing','|',  // âœ… HTML ì†ŒìŠ¤ í¸ì§‘ íƒ­ ì¶”ê°€
                        'undo','redo'
                        ]
                    },
                    language: 'ko',
                    image: {
                    toolbar: [
                        'imageTextAlternative','|',
                        'imageStyle:alignLeft','imageStyle:alignCenter','imageStyle:alignRight'
                    ]
                    },
                    table: {
                    contentToolbar: [ 'tableColumn','tableRow','mergeTableCells' ]
                    },
                    simpleUpload: {
                    uploadUrl: `${API_BASE_URL}/upload/image`,
                    withCredentials: true
                    },
                    // âœ… Source Editing í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
                    sourceEditing: {
                        allowCollaborationFeatures: true,
                        language: 'html'
                    },
                    // HTML íƒœê·¸ í‘œì‹œ ì„¤ì •
                    htmlSupport: {
                        allow: [
                            {
                                name: 'div',
                                attributes: true,
                                classes: true,
                                styles: true
                            },
                            {
                                name: 'img',
                                attributes: true,
                                classes: true,
                                styles: true
                            }
                        ]
                    },
                    // ì´ë¯¸ì§€ ì„¤ì •
                    image: {
                        toolbar: [
                            'imageTextAlternative','|',
                            'imageStyle:alignLeft','imageStyle:alignCenter','imageStyle:alignRight'
                        ],
                        // ì´ë¯¸ì§€ URL ë³€í™˜ ì„¤ì •
                        upload: {
                            types: ['jpeg', 'jpg', 'png', 'gif', 'webp']
                        }
                    }
                })
                .then(newEditor => {
                    ckEditor = newEditor;
                
                    // ì—ë””í„° ë‚´ìš© ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                    ckEditor.model.document.on('change:data', () => {
                        // ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ ì—…ë°ì´íŠ¸
                        if (document.getElementById('live-preview')) {
                            updateLivePreview();
                        }
                        updateHtmlSource();
                    });
                
                showEditorResult('ì—ë””í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                // ë°˜ì‘í˜• ì²˜ë¦¬ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                setupResponsiveEditor();
                    
                    // í˜„ì¬ ì„ íƒëœ í˜ì´ì§€ì˜ ì»¨í…ì¸ ê°€ ìˆë‹¤ë©´ ìë™ìœ¼ë¡œ ë¡œë“œ
                    const pageCode = document.getElementById('editor-page-code').value;
                    if (pageCode && window.originalHtmlContent) {
                        const convertedContent = convertImageUrls(window.originalHtmlContent);
                        ckEditor.setData(convertedContent);
                        showEditorResult('ì„ íƒëœ í˜ì´ì§€ì˜ ì»¨í…ì¸ ê°€ ì—ë””í„°ì— ìë™ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    }
                    
                    return newEditor; // âœ… resolve ê°’ ë¦¬í„´
                })
                .catch(error => {
                    console.error('CKEditor 5 Superbuild ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    showEditorResult('ì—ë””í„° ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    throw error; // âœ… ì—ëŸ¬ ì „íŒŒ
                });
        }
        
        // ë°˜ì‘í˜• ì—ë””í„° ì„¤ì •
        function setupResponsiveEditor() {
            if (!ckEditor) return;
            
            // ì—ë””í„° ì»¨í…ì¸  ë³€ê²½ ì‹œ ë°˜ì‘í˜• ì²˜ë¦¬
            ckEditor.model.document.on('change:data', () => {
                setTimeout(() => {
                    makeEditorContentResponsive();
                }, 100);
            });
            
            // ì´ˆê¸° ë°˜ì‘í˜• ì²˜ë¦¬
            makeEditorContentResponsive();
        }
        
        // ì—ë””í„° ì»¨í…ì¸ ë¥¼ ë°˜ì‘í˜•ìœ¼ë¡œ ë§Œë“¤ê¸°
        function makeEditorContentResponsive() {
            if (!ckEditor) return;
            
            const editableElement = ckEditor.editing.view.document.getRoot();
            if (!editableElement) return;
            
            // ì—ë””í„° ë‚´ë¶€ì˜ ëª¨ë“  ì´ë¯¸ì§€ ìš”ì†Œ ì²˜ë¦¬
            const images = editableElement.getChildren().filter(child => 
                child.is('element') && child.name === 'img'
            );
            
            images.forEach(img => {
                const viewElement = ckEditor.editing.mapper.toViewElement(img);
                if (viewElement) {
                    viewElement.setStyle('max-width', '100%');
                    viewElement.setStyle('height', 'auto');
                }
            });
            
            // ì—ë””í„° ë‚´ë¶€ì˜ ëª¨ë“  í…Œì´ë¸” ìš”ì†Œ ì²˜ë¦¬
            const tables = editableElement.getChildren().filter(child => 
                child.is('element') && child.name === 'table'
            );
            
            tables.forEach(table => {
                const viewElement = ckEditor.editing.mapper.toViewElement(table);
                if (viewElement) {
                    viewElement.setStyle('max-width', '100%');
                    viewElement.setStyle('table-layout', 'fixed');
                    viewElement.setStyle('word-wrap', 'break-word');
                }
            });
            
            // ì—ë””í„° ë‚´ë¶€ì˜ ëª¨ë“  div ìš”ì†Œ ì²˜ë¦¬
            const divs = editableElement.getChildren().filter(child => 
                child.is('element') && child.name === 'div'
            );
            
            divs.forEach(div => {
                const viewElement = ckEditor.editing.mapper.toViewElement(div);
                if (viewElement) {
                    viewElement.setStyle('max-width', '100%');
                    viewElement.setStyle('word-wrap', 'break-word');
                }
            });
        }
        
        
        // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        window.updateLivePreview = function() {
            const previewDiv = document.getElementById('live-preview');
            
            // ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ
            if (!previewDiv) {
                console.warn('live-preview ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                return;
            }
            
            // CKEditorì—ì„œ ì»¨í…ì¸  ê°€ì ¸ì˜¤ê¸°
            const mainHtml = ckEditor ? ckEditor.getData() : '';
            
            if (mainHtml.trim()) {
                // CSS ìŠ¤íƒ€ì¼ì„ í¬í•¨í•œ ì™„ì „í•œ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                const styledHtml = `
                    <div style="
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        line-height: 1.6;
                        color: #333;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            text-align: center;
                            font-size: 14px;
                        ">
                            ğŸ“ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
                        </div>
                        <div style="
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        ">
                            ${mainHtml}
                        </div>
                    </div>
                `;
                previewDiv.innerHTML = styledHtml;
            } else {
                previewDiv.innerHTML = `
                    <div style="
                        text-align: center; 
                        margin-top: 100px; 
                        color: #6c757d;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    ">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
                        <p>ì»¨í…ì¸ ë¥¼ í¸ì§‘í•˜ë©´ ì—¬ê¸°ì— ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        <p style="font-size: 14px; margin-top: 10px;">í¸ì§‘ ëª¨ë“œë¥¼ í™œì„±í™”í•˜ê³  HTMLì„ ì…ë ¥í•´ë³´ì„¸ìš”.</p>
                    </div>
                `;
            }
        }
        
        // HTML ì†ŒìŠ¤ ì½”ë“œ ì—…ë°ì´íŠ¸ (í˜„ì¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        window.updateHtmlSource = function() {
            // HTML ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ì€ í˜„ì¬ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
            // í•„ìš”ì‹œ ë‚˜ì¤‘ì— êµ¬í˜„
        }
        
        
        
        
        
        
        // ì„ì‹œ ì €ì¥ (ë¯¸ë¦¬ë³´ê¸°ìš©)
        window.savePreviewContent = async function() {
            const pageCode = document.getElementById('editor-page-code').value;
            const pageTitle = document.getElementById('editor-page-title').value;
            
            if (!pageCode || !pageTitle) {
                showEditorResult('í˜ì´ì§€ ì½”ë“œì™€ ì œëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!ckEditor) {
                showEditorResult('ì—ë””í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const mainHtml = ckEditor.getData();
            
            if (!mainHtml.trim()) {
                showEditorResult('ì €ì¥í•  HTML ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // ì´ë¯¸ì§€ URLì„ ìƒëŒ€ ê²½ë¡œë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
            const contentToSave = revertImageUrls(mainHtml);
            
            try {
                const contentData = {
                    pageTitle: pageTitle,
                    pageContent: contentToSave,
                    metaTitle: pageTitle,
                    metaDescription: '',
                    metaKeywords: '',
                    status: 'ACTIVE',
                    updatedBy: 'test-user'
                };
                
                const response = await fetch(`/api/cms/content/preview/${pageCode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contentData)
                });
                
                if (response.ok) {
                    const savedContent = await response.json();
                    
                    // ì €ì¥ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                    const saveButton = document.querySelector('[onclick="savePreviewContent()"]');
                    saveButton.style.background = '#ffc107';
                    saveButton.textContent = 'ì„ì‹œ ì €ì¥';
                    
                    // ë°±ì—… ì—…ë°ì´íŠ¸
                    window.mainHtmlBackup = mainHtml;
                    
                    showEditorResult(`ì„ì‹œ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. "ì„ì‹œ ì €ì¥ëœ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°"ë¡œ í™•ì¸í•˜ì„¸ìš”. (${savedContent.pageTitle})`, 'success');
                } else {
                    throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + response.status);
                }
            } catch (error) {
                showEditorResult('ì„ì‹œ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ìµœì¢… ì €ì¥ (ì„ì‹œ ì €ì¥ëœ ë‚´ìš©ì„ ì‹¤ì œ ì»¨í…ì¸ ë¡œ ì ìš©)
        window.applyPreviewContent = async function() {
            const pageCode = document.getElementById('editor-page-code').value;
            
            if (!pageCode.trim()) {
                showEditorResult('í˜ì´ì§€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // ìµœì¢… ì €ì¥ ì „ í™•ì¸
            const confirmApply = confirm(`ì„ì‹œ ì €ì¥ëœ ë‚´ìš©ì„ ì‹¤ì œ í˜ì´ì§€ì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜ì´ì§€ ì½”ë“œ: ${pageCode}\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            
            if (!confirmApply) {
                showEditorResult('ìµœì¢… ì €ì¥ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/cms/content/apply-preview/${pageCode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const appliedContent = await response.json();
                    
                    // ì›ë³¸ HTML ì—…ë°ì´íŠ¸
                    window.originalHtmlContent = appliedContent.pageContent;
                    
                    showEditorResult(`ìµœì¢… ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì œ í˜ì´ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. (${appliedContent.pageTitle})`, 'success');
                } else {
                    throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + response.status);
                }
            } catch (error) {
                showEditorResult('ìµœì¢… ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ë©”ì¸ HTMLì„ CKEditorë¡œ ë¡œë“œ
        
        // ì „ì²´ ì»¨í…ì¸  ëª©ë¡ ì¡°íšŒ
        window.loadAllContents = async function() {
            try {
                showEditorResult('ì»¨í…ì¸  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
                
                const response = await fetch('/api/cms/contents');
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // APIê°€ ì§ì ‘ ë°°ì—´ì„ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸
                    const contents = Array.isArray(result) ? result : (result.data || []);
                    
                    const selectElement = document.getElementById('editor-page-select');
                    selectElement.innerHTML = '<option value="">í˜ì´ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>';
                    
                    if (contents.length === 0) {
                        showEditorResult('ë“±ë¡ëœ ì»¨í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                        return;
                    }
                    
                    contents.forEach(content => {
                        const option = document.createElement('option');
                        option.value = content.pageCode;
                        option.textContent = `${content.pageCode} - ${content.pageTitle}`;
                        option.setAttribute('data-page-title', content.pageTitle);
                        selectElement.appendChild(option);
                    });
                    
                    showEditorResult(`ì´ ${contents.length}ê°œì˜ ì»¨í…ì¸ ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    const errorText = await response.text();
                    console.error('API ì˜¤ë¥˜ ì‘ë‹µ:', errorText);
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('ì»¨í…ì¸  ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
                showEditorResult('ì»¨í…ì¸  ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ë“œë¡­ë‹¤ìš´ì—ì„œ í˜ì´ì§€ ì„ íƒ ì‹œ ì»¨í…ì¸  ë¡œë“œ
        window.onPageSelect = function() {
            const selectElement = document.getElementById('editor-page-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            
            if (selectedOption.value) {
                const pageCode = selectedOption.value;
                const pageTitle = selectedOption.getAttribute('data-page-title');
                
                // ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
                document.getElementById('editor-page-code').value = pageCode;
                document.getElementById('editor-page-title').value = pageTitle;
                
                // ì»¨í…ì¸  ìë™ ë¡œë“œ
                loadContentForEdit();
            } else {
                // ì„ íƒ í•´ì œ ì‹œ ì´ˆê¸°í™”
                document.getElementById('editor-page-code').value = '';
                document.getElementById('editor-page-title').value = '';
                if (ckEditor) {
                    ckEditor.setData('');
                }
            }
        }
        
        // page_contentë¥¼ preview_contentì— ë³µì‚¬í•˜ì—¬ ì´ˆê¸°í™”
        window.initializePreviewContent = async function(pageCode, pageContent) {
            try {
                
                const previewData = {
                    pageCode: pageCode,
                    previewContent: pageContent,
                    updatedBy: 'system-init'
                };
                
                const response = await fetch(`/api/cms/content/preview/${pageCode}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(previewData)
                });
                
                if (response.ok) {
                    showEditorResult('ë¯¸ë¦¬ë³´ê¸° ì»¨í…ì¸ ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    console.warn('preview_content ì´ˆê¸°í™” ì‹¤íŒ¨:', response.status);
                    // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (í•„ìˆ˜ ê¸°ëŠ¥ì´ ì•„ë‹ˆë¯€ë¡œ)
                }
            } catch (error) {
                console.error('preview_content ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰ (í•„ìˆ˜ ê¸°ëŠ¥ì´ ì•„ë‹ˆë¯€ë¡œ)
            }
        }
        
        // ì»¨í…ì¸  ë¶ˆëŸ¬ì˜¤ê¸°
        window.loadContentForEdit = async function() {
            const pageCode = document.getElementById('editor-page-code').value;
            const resultDiv = document.getElementById('editor-result');
            
            
            if (!pageCode) {
                showEditorResult('í˜ì´ì§€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                showEditorResult('ì»¨í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
                const response = await fetch(`/api/cms/content/${pageCode}`);
                
                if (response.ok) {
                    const content = await response.json();
                    
                    // ì›ë³¸ HTML ë‚´ìš©ì„ ë³„ë„ë¡œ ì €ì¥ (DBì—ì„œ ê°€ì ¸ì˜¨ ê·¸ëŒ€ë¡œ)
                    window.originalHtmlContent = content.pageContent;
                    
                    // page_contentë¥¼ preview_contentì— ë³µì‚¬í•˜ì—¬ ì´ˆê¸°í™”
                    await initializePreviewContent(pageCode, content.pageContent);
                    
                    // ì´ë¯¸ì§€ URLì„ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜í•˜ì—¬ ì—ë””í„°ì— í‘œì‹œ
                    const convertedContent = convertImageUrls(content.pageContent);
                    
                    // ì—ë””í„°ì— ì»¨í…ì¸  ì„¤ì •
                    if (ckEditor) {
                        ckEditor.setData(convertedContent);
                    } else {
                        // ì—ë””í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš° ìë™ ì´ˆê¸°í™” í›„ ì»¨í…ì¸  ì„¤ì •
                        showEditorResult('ì—ë””í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì»¨í…ì¸ ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤...', 'info');
                        try {
                            await initializeCKEditor();
                            // ì´ˆê¸°í™” ì™„ë£Œ í›„ ì ì‹œ ëŒ€ê¸°
                            await new Promise(resolve => setTimeout(resolve, 1000));
                    if (ckEditor) {
                        ckEditor.setData(content.pageContent);
                            }
                        } catch (error) {
                            console.error('ì—ë””í„° ìë™ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                            showEditorResult('ì—ë””í„° ìë™ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”.', 'error');
                        }
                    }
                    
                    // í˜ì´ì§€ ì •ë³´ ì„¤ì •
                    document.getElementById('editor-page-title').value = content.pageTitle;
                    currentPageCode = content.pageCode;
                    currentPageTitle = content.pageTitle;
                    
                    // HTML ì½”ë“œ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì›ë³¸ HTML í‘œì‹œ (ì œê±°ëœ ê¸°ëŠ¥ì´ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬)
                    // if (document.getElementById('code-panel').classList.contains('active')) {
                    //     showBothHtml();
                    // }
                    
                    showEditorResult(`ì»¨í…ì¸ ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (${content.pageTitle})`, 'success');
                } else if (response.status === 404) {
                    showEditorResult(`í˜ì´ì§€ ì½”ë“œ '${pageCode}'ì— í•´ë‹¹í•˜ëŠ” ì»¨í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                } else {
                    const errorText = await response.text();
                    console.error('API ì˜¤ë¥˜ ì‘ë‹µ:', errorText);
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('ì»¨í…ì¸  ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showEditorResult('ì»¨í…ì¸  ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ì»¨í…ì¸  ì €ì¥ (CKEditorìš©)
        window.saveContent = async function() {
            const pageCode = document.getElementById('editor-page-code').value;
            const pageTitle = document.getElementById('editor-page-title').value;
            const resultDiv = document.getElementById('editor-result');
            
            if (!pageCode || !pageTitle) {
                showEditorResult('í˜ì´ì§€ ì½”ë“œì™€ ì œëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!ckEditor) {
                showEditorResult('ì—ë””í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì—ë””í„° ì¬ì´ˆê¸°í™” ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // CKEditorê°€ ì™„ì „íˆ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!ckEditor.model || !ckEditor.model.document) {
                showEditorResult('ì—ë””í„°ê°€ ì•„ì§ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const pageContent = ckEditor.getData();
            
            // ì´ë¯¸ì§€ URLì„ ìƒëŒ€ ê²½ë¡œë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
            const contentToSave = revertImageUrls(pageContent);
            
            try {
                const contentData = {
                    pageTitle: pageTitle,
                    pageContent: contentToSave,
                    status: 'ACTIVE',
                    updatedBy: 'test-user'
                };
                
                // í˜ì´ì§€ ì½”ë“œ ê¸°ë°˜ ì—…ë°ì´íŠ¸ API ì‚¬ìš©
                const response = await fetch(`/api/cms/content/page/${pageCode}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contentData)
                });
                
                if (response.ok) {
                    const savedContent = await response.json();
                    currentPageCode = savedContent.pageCode;
                    currentPageTitle = savedContent.pageTitle;
                    showEditorResult(`ì»¨í…ì¸ ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${savedContent.pageTitle})`, 'success');
                } else {
                    throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + response.status);
                }
            } catch (error) {
                showEditorResult('ì»¨í…ì¸  ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ì €ì¥ ì „)
        window.previewCurrentContent = function() {
            const mainHtml = document.getElementById('main-html-editor').value;
            const pageCode = document.getElementById('editor-page-code').value;
            
            if (!mainHtml.trim()) {
                showEditorResult('ë¯¸ë¦¬ë³´ê¸°í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (!pageCode.trim()) {
                showEditorResult('í˜ì´ì§€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // cms-template.htmlì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ë¯¸ë¦¬ë³´ê¸° URL ìƒì„±
            const previewUrl = `/cms-template.html?page=${pageCode}&preview=true&content=${encodeURIComponent(mainHtml)}`;
            
            // ìƒˆ ì°½ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì—´ê¸°
            const previewWindow = window.open(previewUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (!previewWindow) {
                showEditorResult('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showEditorResult('í˜„ì¬ í¸ì§‘ ë‚´ìš©ì´ ì‹¤ì œ í˜ì´ì§€ì™€ ë™ì¼í•œ í˜•íƒœë¡œ ë¯¸ë¦¬ë³´ê¸°ë©ë‹ˆë‹¤.', 'success');
        }
        
        // ì„ì‹œ ì €ì¥ëœ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°
        window.previewSavedContent = function() {
            const pageCode = document.getElementById('editor-page-code').value;
            
            if (!pageCode.trim()) {
                showEditorResult('í˜ì´ì§€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œë¡œ cms-template.html ì—´ê¸°
            const previewUrl = `/cms-template.html?page=${pageCode}&preview=true`;
            
            // ìƒˆ ì°½ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì—´ê¸°
            const previewWindow = window.open(previewUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (!previewWindow) {
                showEditorResult('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showEditorResult('ì„ì‹œ ì €ì¥ëœ ë‚´ìš©ì´ ì‹¤ì œ í˜ì´ì§€ì™€ ë™ì¼í•œ í˜•íƒœë¡œ ë¯¸ë¦¬ë³´ê¸°ë©ë‹ˆë‹¤.', 'success');
        }
        
        // ì‹¤ì œ í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸° (ì €ì¥ëœ ë‚´ìš©)
        window.previewContent = function() {
            const pageCode = document.getElementById('editor-page-code').value;
            if (!pageCode) {
                showEditorResult('í˜ì´ì§€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const modal = document.getElementById('preview-modal');
            const iframe = document.getElementById('preview-iframe');
            
            iframe.src = `/cms-template.html?page=${pageCode}`;
            modal.style.display = 'block';
            
            showEditorResult('ì‹¤ì œ í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'success');
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
        window.closePreviewModal = function() {
            const modal = document.getElementById('preview-modal');
            modal.style.display = 'none';
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ìƒˆë¡œê³ ì¹¨
        window.refreshPreview = function() {
            const iframe = document.getElementById('preview-iframe');
            iframe.src = iframe.src;
        }
        
        // ìƒˆ íƒ­ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì—´ê¸°
        window.openPreviewInNewTab = function() {
            const pageCode = document.getElementById('editor-page-code').value;
            if (pageCode) {
                window.open(`/cms-template.html?page=${pageCode}`, '_blank');
            }
        }
        
        // ìƒˆ íƒ­ì—ì„œ ì—´ê¸° (í¸ì§‘ê¸°ì—ì„œ)
        window.openInNewTab = function() {
            const pageCode = document.getElementById('editor-page-code').value;
            if (pageCode) {
                window.open(`/cms-template.html?page=${pageCode}`, '_blank');
            } else {
                showEditorResult('í˜ì´ì§€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            }
        }
        
        // ì—ë””í„° ê²°ê³¼ í‘œì‹œ
        window.showEditorResult = function(message, type) {
            const resultDiv = document.getElementById('editor-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = message;
            
            if (type === 'success') {
                resultDiv.style.backgroundColor = '#d4edda';
                resultDiv.style.borderColor = '#c3e6cb';
                resultDiv.style.color = '#155724';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.borderColor = '#f5c6cb';
                resultDiv.style.color = '#721c24';
            } else if (type === 'warning') {
                resultDiv.style.backgroundColor = '#fff3cd';
                resultDiv.style.borderColor = '#ffeaa7';
                resultDiv.style.color = '#856404';
            }
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('preview-modal');
            if (event.target === modal) {
                closePreviewModal();
            }
        }
        
        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        
        
        
        
        // TOP ë²„íŠ¼ ì„¤ì •
        window.setupTopButton = function() {
            const topBtn = document.getElementById("toTopBtn");
            
            window.addEventListener("scroll", function () {
                const showPoint = window.innerHeight * 1.2;
                
                if (window.scrollY > showPoint) {
                    topBtn.classList.add("show");
                } else {
                    topBtn.classList.remove("show");
                }
            });
            
            topBtn.addEventListener("click", function () {
                window.scrollTo({
                    top: 0,
                    behavior: "smooth"
                });
            });
        }
        
        // ê³µí†µ ì‚¬ì´ë“œë°” ë¡œë“œ
        async function loadAdminSidebar() {
            try {
                const response = await fetch('/admin/common/admin-sidebar.html');
                if (response.ok) {
                    const sidebarHTML = await response.text();
                    const container = document.getElementById('adminSidebarContainer');
                    if (container) {
                        container.innerHTML = sidebarHTML;
                        
                        // ì‚¬ì´ë“œë°” ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                        setupSidebarEvents();
                        
                        // ë©”ë‰´ ë¡œë“œ
                        loadAdminMenus();
                    } else {
                        console.error('Admin sidebar container not found');
                    }
                } else {
                    console.error('Failed to load admin sidebar, status:', response.status);
                }
            } catch (error) {
                console.error('Error loading admin sidebar:', error);
            }
        }

        // ì–´ë“œë¯¼ ë©”ë‰´ ë¡œë“œ (ê¶Œí•œ ê¸°ë°˜)
        async function loadAdminMenus() {
            try {
                const response = await fetch(`${window.location.origin}/api/admin-menus/accessible`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const menus = await response.json();
                    renderMenus(menus);
                } else {
                    console.error('Failed to load accessible menus, status:', response.status);
                    showMenuError('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ: ' + response.status + ')');
                }
            } catch (error) {
                console.error('Error loading accessible admin menus:', error);
                showMenuError('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë©”ë‰´ ë Œë”ë§
        function renderMenus(menus) {
            const menuContainer = document.getElementById('sidebarMenu');
            
            if (!menuContainer) {
                console.error('Menu container not found!');
                return;
            }
            
            if (menus.length === 0) {
                menuContainer.innerHTML = '<li class="loading">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            menuContainer.innerHTML = menus.map(menu => `
                <li class="menu-item">
                    <a class="menu-link" 
                       href="${menu.menuUrl || '#'}" 
                       data-menu-id="${menu.menuNo}">
                        <span class="menu-icon">${getMenuIcon(menu.menuIcon)}</span>
                        <span class="menu-text">${menu.menuName}</span>
                    </a>
                </li>
            `).join('');

        }

        // ë©”ë‰´ ì•„ì´ì½˜ ë§¤í•‘
        function getMenuIcon(iconName) {
            const iconMap = {
                'dashboard': 'ğŸ“Š',
                'content_copy': 'ğŸ“„',
                'people': 'ğŸ‘¥',
                'settings': 'âš™ï¸',
                'announcement': 'ğŸ“¢',
                'newspaper': 'ğŸ“°',
                'menu': 'ğŸ“‹',
                'admin_panel_settings': 'ğŸ‘¤',
                'tune': 'ğŸ›ï¸',
                'history': 'ğŸ“œ'
            };
            return iconMap[iconName] || 'ğŸ“';
        }

        // ë©”ë‰´ ì˜¤ë¥˜ í‘œì‹œ
        function showMenuError(message) {
            const menuContainer = document.getElementById('sidebarMenu');
            if (menuContainer) {
                menuContainer.innerHTML = `<li class="loading">${message}</li>`;
            }
        }

        // ì‚¬ì´ë“œë°” ì´ë²¤íŠ¸ ì„¤ì •
        function setupSidebarEvents() {
            // ì‚¬ì´ë“œë°” í† ê¸€ ì´ë²¤íŠ¸
            const toggleBtn = document.querySelector('.sidebar-toggle');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const sidebar = document.getElementById('adminSidebar');
                    const mainContent = document.querySelector('.main-content');
                    
                    if (sidebar && mainContent) {
                        sidebar.classList.toggle('collapsed');
                        mainContent.classList.toggle('sidebar-collapsed');
                    }
                });
            }
        }

        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener("DOMContentLoaded", function () {
            loadAdminSidebar(); // ì‚¬ì´ë“œë°” ë¡œë“œ
            setupTopButton();
            initializeCKEditor();
            loadAllContents(); // ì»¨í…ì¸  ëª©ë¡ ìë™ ë¡œë“œ
            loadUserInfo(); // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
            initializeAdmin();
        });

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/account', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const user = await response.json();
                    const userNameElement = document.getElementById('headerUserName');
                    if (userNameElement) {
                        userNameElement.textContent = user.userName || 'ê´€ë¦¬ì';
                    }
                } else {
                    console.error('Failed to load user info, status:', response.status);
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        function logout() {
            localStorage.removeItem('kitms_token');
            localStorage.removeItem('admin_user');
            window.location.href = '/admin/login';
        }

        function initializeAdmin() {
            // ì‚¬ìš©ì ì •ë³´ëŠ” loadUserInfo()ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì¶”ê°€ ì‘ì—…ë§Œ ìˆ˜í–‰
        }
        
        // ì´ë¯¸ì§€ URL ë³€í™˜ í•¨ìˆ˜ (ìƒëŒ€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ)
        window.convertImageUrls = function(htmlContent) {
            if (!htmlContent) return htmlContent;
            
            // ìƒëŒ€ ê²½ë¡œ ì´ë¯¸ì§€ë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
            return htmlContent.replace(
                /src="\.\/images\//g, 
                'src="/images/'
            ).replace(
                /src="images\//g, 
                'src="/images/'
            );
        }
        
        // ì´ë¯¸ì§€ URL ì—­ë³€í™˜ í•¨ìˆ˜ (ì ˆëŒ€ ê²½ë¡œë¥¼ ìƒëŒ€ ê²½ë¡œë¡œ)
        window.revertImageUrls = function(htmlContent) {
            if (!htmlContent) return htmlContent;
            
            // ì ˆëŒ€ ê²½ë¡œ ì´ë¯¸ì§€ë¥¼ ìƒëŒ€ ê²½ë¡œë¡œ ë³€í™˜
            return htmlContent.replace(
                /src="\/images\//g, 
                'src="./images/'
            );
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ CKEditor ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ CKEditor ì´ˆê¸°í™”
            setTimeout(() => {
                initializeCKEditor();
            }, 500);
        });
    </script>
            </div> <!-- test-container -->
        </main> <!-- main-content -->
    </div> <!-- admin-container -->
</body>
</html>
