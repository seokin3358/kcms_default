# KITMS 환경 설정 가이드

## 🔧 환경 변수 및 설정

### 1. 데이터베이스 설정

#### 개발 환경 (`application-dev.yml`)
```yaml
spring:
  datasource:
    url: jdbc:mariadb://localhost:3306/kitms
    username: kitms
    password: kitms123!
    driver-class-name: org.mariadb.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MariaDBDialect
        format_sql: true
```

#### 프로덕션 환경 (`application-prod.yml`)
```yaml
spring:
  datasource:
    url: jdbc:mariadb://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:kitms}
    username: ${DB_USERNAME:kitms}
    password: ${DB_PASSWORD:kitms123!}
    driver-class-name: org.mariadb.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
```

### 2. 로깅 설정

#### 개발 환경
```yaml
logging:
  level:
    ROOT: DEBUG
    tech.jhipster: DEBUG
    org.hibernate.SQL: DEBUG
    com.kone.kitms: DEBUG
  file:
    name: ~/var/kitms/log/kitms_server_log.log
```

#### 프로덕션 환경
```yaml
logging:
  level:
    ROOT: INFO
    com.kone.kitms: INFO
  file:
    name: ~/var/kitms/log/kitms_server_log.log
    max-size: 100MB
    max-history: 30
```

### 3. 보안 설정

#### JWT 설정
```yaml
jhipster:
  security:
    authentication:
      jwt:
        base64-secret: your-secret-key-here
        token-validity-in-seconds: 86400
        token-validity-in-seconds-for-remember-me: 2592000
```

#### 이미지 보안 설정
```java
// SecureImageController.java
private static final long SESSION_TOKEN_EXPIRY_TIME = 2 * 60 * 60 * 1000; // 2시간
private static final long IMAGE_TOKEN_EXPIRY_TIME = 2 * 60 * 60 * 1000;   // 2시간
```

---

## 🚀 배포 환경별 설정

### 1. 개발 환경 실행
```bash
# 환경 변수 설정
export SPRING_PROFILES_ACTIVE=dev
export DB_HOST=localhost
export DB_PORT=3306
export DB_NAME=kitms
export DB_USERNAME=kitms
export DB_PASSWORD=kitms123!

# 애플리케이션 실행
./mvnw spring-boot:run
```

### 2. 프로덕션 환경 실행
```bash
# 환경 변수 설정
export SPRING_PROFILES_ACTIVE=prod
export DB_HOST=your-db-host
export DB_PORT=3306
export DB_NAME=kitms
export DB_USERNAME=kitms
export DB_PASSWORD=your-secure-password

# JWT 시크릿 키 설정
export JHIPSTER_SECURITY_AUTHENTICATION_JWT_BASE64_SECRET=your-base64-secret

# 애플리케이션 실행
java -jar target/kitms-0.0.1-SNAPSHOT.jar
```

### 3. Docker 환경 실행
```bash
# Docker Compose 사용
docker-compose up -d

# 또는 Docker 직접 실행
docker run -d \
  --name kitms \
  -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e DB_HOST=your-db-host \
  -e DB_USERNAME=kitms \
  -e DB_PASSWORD=your-password \
  kitms:latest
```

---

## 📁 중요 파일 위치

### 설정 파일
- `src/main/resources/config/application.yml`: 기본 설정
- `src/main/resources/config/application-dev.yml`: 개발 환경 설정
- `src/main/resources/config/application-prod.yml`: 프로덕션 환경 설정
- `src/main/resources/config/application-image-paths.yml`: 이미지 경로 설정

### 데이터베이스 마이그레이션
- `src/main/resources/db/migration/`: Liquibase 마이그레이션 파일
- `src/main/resources/db/changelog/`: 데이터베이스 변경 로그

### 정적 파일
- `src/main/resources/static/`: HTML, CSS, JavaScript, 이미지 파일
- `src/main/resources/static/images/`: 이미지 파일들
- `src/main/resources/static/style/`: CSS 파일들

### 로그 파일
- `~/var/kitms/log/kitms_server_log.log`: 애플리케이션 로그
- `~/var/kitms/log/kitms_server_log.YYYY-MM-DD_N.log`: 일별 로그 파일

---

## 🔍 모니터링 및 디버깅

### 1. 헬스 체크
```bash
# 애플리케이션 상태 확인
curl http://localhost:8080/management/health

# 상세 정보 확인 (관리자 권한 필요)
curl http://localhost:8080/management/health/detail
```

### 2. 로그 모니터링
```bash
# 실시간 로그 확인
tail -f ~/var/kitms/log/kitms_server_log.log

# 에러 로그만 확인
grep "ERROR" ~/var/kitms/log/kitms_server_log.log

# 특정 시간대 로그 확인
grep "2025-01-26 10:" ~/var/kitms/log/kitms_server_log.log
```

### 3. 데이터베이스 연결 확인
```sql
-- 연결 상태 확인
SHOW PROCESSLIST;

-- 테이블 상태 확인
SHOW TABLE STATUS;

-- 사용자 권한 확인
SHOW GRANTS FOR 'kitms'@'localhost';
```

---

## 🛠️ 문제 해결 가이드

### 1. 데이터베이스 연결 오류
```bash
# 연결 테스트
mysql -h localhost -u kitms -p kitms

# 방화벽 확인
telnet localhost 3306

# MariaDB 서비스 상태 확인
systemctl status mariadb
```

### 2. 포트 충돌 문제
```bash
# 포트 사용 확인
netstat -tulpn | grep :8080

# 프로세스 종료
kill -9 $(lsof -t -i:8080)
```

### 3. 메모리 부족 문제
```bash
# JVM 힙 메모리 증가
java -Xmx2G -Xms1G -jar target/kitms-0.0.1-SNAPSHOT.jar

# 메모리 사용량 확인
free -h
top -p $(pgrep java)
```

### 4. 이미지 로딩 문제
```bash
# 이미지 파일 권한 확인
ls -la src/main/resources/static/images/

# 토큰 상태 확인 (API 호출)
curl http://localhost:8080/api/secure-images/mapping
```

---

## 📋 백업 및 복구

### 1. 데이터베이스 백업
```bash
# 전체 데이터베이스 백업
mysqldump -u kitms -p kitms > kitms_backup_$(date +%Y%m%d).sql

# 특정 테이블만 백업
mysqldump -u kitms -p kitms kitms_user kitms_notice > tables_backup.sql
```

### 2. 파일 백업
```bash
# 정적 파일 백업
tar -czf static_files_backup.tar.gz src/main/resources/static/

# 설정 파일 백업
cp -r src/main/resources/config/ config_backup/
```

### 3. 복구 절차
```bash
# 데이터베이스 복구
mysql -u kitms -p kitms < kitms_backup_20250126.sql

# 파일 복구
tar -xzf static_files_backup.tar.gz
```

---

## 🔐 보안 체크리스트

### 정기 보안 점검
- [ ] 데이터베이스 비밀번호 강도 확인
- [ ] JWT 시크릿 키 주기적 변경
- [ ] 이미지 토큰 만료 시간 적절성 검토
- [ ] 로그 파일 접근 권한 확인
- [ ] 방화벽 설정 검토
- [ ] SSL/TLS 인증서 유효성 확인

### 보안 설정 권장사항
```yaml
# 프로덕션 환경 보안 강화
server:
  servlet:
    session:
      cookie:
        secure: true
        http-only: true
        same-site: strict
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: your-keystore-password
```

---

**문서 버전**: 1.0  
**마지막 업데이트**: 2025년 1월 26일

